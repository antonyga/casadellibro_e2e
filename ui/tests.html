<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TestPilot â€” Test Suites</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* â”€â”€ Terminal modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .terminal-wrap {
      background: #0d1117;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      padding: 16px 20px;
      height: 380px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .terminal-line {
      font-family: 'SF Mono', 'Fira Code', Consolas, 'Courier New', monospace;
      font-size: 0.76rem;
      line-height: 1.75;
      white-space: pre-wrap;
      word-break: break-all;
      color: #c9d1d9;
    }
    .terminal-line.success { color: #3fb950; }
    .terminal-line.error   { color: #f85149; }
    .terminal-line.warn    { color: #d29922; }
    .terminal-line.info    { color: #58a6ff; }

    /* Spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,0.25);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }

    .terminal-modal-header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .terminal-modal-header h3 {
      color: #c9d1d9;
      font-size: 0.88rem;
      flex: 1;
    }
    .terminal-modal-header button {
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
    }
    .terminal-modal-header button:hover { color: #c9d1d9; }

    .terminal-footer {
      background: #161b22;
      border-top: 1px solid #30363d;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .terminal-result-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      font-weight: 700;
    }
    .terminal-result-badge.passed { color: #3fb950; }
    .terminal-result-badge.failed { color: #f85149; }
    .terminal-result-badge.running { color: #58a6ff; }

    /* Override modal background for terminal */
    #terminalModal .modal {
      max-width: 740px;
      padding: 0;
      border: 1px solid #30363d;
      background: #0d1117;
      overflow: hidden;
    }

    /* Run button disabled state */
    .btn[disabled] { opacity: 0.45; pointer-events: none; }

    /* â”€â”€ History modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .report-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: border-color 0.15s;
    }
    .report-card:hover { border-color: var(--accent); }
    .report-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
    }
    .report-card-meta {
      font-size: 0.72rem;
      color: var(--text-secondary);
    }
    .report-card-results {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .report-result-pill {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.73rem;
      padding: 3px 8px;
      border-radius: 99px;
      font-weight: 600;
    }
    .report-result-pill.passed { background: var(--success-light); color: var(--success); }
    .report-result-pill.failed { background: var(--error-light);   color: var(--error);   }
    .report-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .history-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .history-empty svg { width: 36px; height: 36px; opacity: 0.25; margin: 0 auto 10px; display: block; }
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/></svg>
    <span class="logo-text">TestPilot</span><span class="logo-badge">BETA</span>
  </div>
  <nav class="sidebar-nav">
    <span class="nav-section-label">Overview</span>
    <a href="index.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span>Dashboard</span>
    </a>
    <a href="tests.html" class="nav-item active">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 3H9.5L9 7.5c0 .5-.5 1-1 1H4a1 1 0 00-1 1V21a1 1 0 001 1h16a1 1 0 001-1V9.5a1 1 0 00-1-1h-4c-.5 0-1-.5-1-1L14.5 3z"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
      <span>Test Suites</span><span class="nav-badge">2</span>
    </a>
    <span class="nav-section-label">Tools</span>
    <a href="codegen.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3l1.88 5.76a1 1 0 00.95.69H21l-4.94 3.6a1 1 0 00-.36 1.12L17.58 20 12 16.24 6.42 20l1.88-5.83a1 1 0 00-.36-1.12L3 9.45h6.17a1 1 0 00.95-.69L12 3z"/></svg>
      <span>AI Generator</span>
    </a>
    <a href="visual.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      <span>Visual Tests</span>
    </a>
    <span class="nav-section-label">Config</span>
    <a href="settings.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      <span>Settings</span>
    </a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-profile">
      <div class="avatar">QA</div>
      <div class="user-info"><span class="user-name">QA Engineer</span><span class="user-role">casadellibro.com</span></div>
    </div>
  </div>
</aside>

<div class="main-layout">
  <header class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">Test Suites</h1>
      <div class="breadcrumb"><span>casadellibro.com</span><span>/</span><span class="crumb-current">Test Suites</span></div>
    </div>
    <div class="topbar-right">
      <div class="env-selector">
        <select><option>ðŸŸ¢  Production</option><option>ðŸŸ¡  Staging</option><option>ðŸ”µ  Pre-prod</option></select>
      </div>
      <button class="btn btn-secondary btn-sm" id="runSelectedBtn" onclick="runSelected()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>
        Run Selected
      </button>
      <button class="btn btn-secondary btn-sm" onclick="openHistory()" title="Report History">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        History
      </button>
      <button class="btn btn-primary btn-sm" onclick="window.location.href='codegen.html'">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Test
      </button>
    </div>
  </header>

  <main class="content">
    <!-- Toolbar -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap">
      <div class="search-bar">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" placeholder="Search testsâ€¦" id="searchInput" oninput="filterTests()" />
      </div>
      <div class="filter-row">
        <button class="filter-chip active" data-filter="all" onclick="setFilter('all',this)">All <span class="count" id="count-all">8</span></button>
        <button class="filter-chip" data-filter="passed" onclick="setFilter('passed',this)">
          <span style="width:7px;height:7px;border-radius:50%;background:var(--success);flex-shrink:0"></span>Passed <span class="count" id="count-passed">5</span>
        </button>
        <button class="filter-chip" data-filter="failed" onclick="setFilter('failed',this)">
          <span style="width:7px;height:7px;border-radius:50%;background:var(--error);flex-shrink:0"></span>Failed <span class="count" id="count-failed">2</span>
        </button>
        <button class="filter-chip" data-filter="running" onclick="setFilter('running',this)">
          <span style="width:7px;height:7px;border-radius:50%;background:var(--running);flex-shrink:0"></span>Running <span class="count" id="count-running">1</span>
        </button>
        <button class="filter-chip" data-filter="flaky" onclick="setFilter('flaky',this)">
          <span style="width:7px;height:7px;border-radius:50%;background:var(--warning);flex-shrink:0"></span>Flaky
        </button>
      </div>
    </div>

    <!-- Bulk Actions bar -->
    <div id="bulkBar" style="display:none;align-items:center;gap:10px;background:var(--accent-light);border:1px solid var(--accent);border-radius:var(--radius-md);padding:10px 16px;margin-bottom:16px;">
      <span style="font-size:0.82rem;font-weight:600;color:var(--accent)" id="bulkCount">0 selected</span>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="bulkRun()">Run Selected</button>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete()">Delete</button>
        <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Cancel</button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table id="testsTable">
        <thead>
          <tr>
            <th style="width:40px"><input type="checkbox" id="selectAll" class="row-check" onchange="toggleAll(this)"/></th>
            <th>Test Name</th>
            <th>Suite File</th>
            <th>Status</th>
            <th>Browser</th>
            <th>Duration</th>
            <th>Last Run</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="testsBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- â”€â”€ Terminal / Run Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="terminalModal">
  <div class="modal" style="max-width:740px;padding:0;background:#0d1117;border:1px solid #30363d;">

    <!-- Header -->
    <div class="terminal-modal-header">
      <div id="terminalSpinner" class="spinner" style="display:none;"></div>
      <h3 id="terminalTitle">Running testsâ€¦</h3>
      <button onclick="cancelRun()" title="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <!-- Output terminal -->
    <div class="terminal-wrap" id="terminalOutput"></div>

    <!-- Footer (shown when run finishes) -->
    <div class="terminal-footer" id="terminalFooter">
      <div class="terminal-result-badge running" id="terminalResultBadge">
        <div class="spinner"></div>
        <span id="terminalResultText">Runningâ€¦</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary btn-sm" onclick="closeTerminal()" style="background:#21262d;border-color:#30363d;color:#c9d1d9;">Close</button>
        <button class="btn btn-primary btn-sm" onclick="openReport()" id="terminalReportBtn" style="display:none;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          View HTML Report
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Report History Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="historyModal" onclick="if(event.target===this)closeModal('historyModal')">
  <div class="modal modal-lg" style="max-width:640px;">
    <div class="modal-header">
      <h3 style="display:flex;align-items:center;gap:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Report History
      </h3>
      <button class="modal-close" onclick="closeModal('historyModal')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="padding:16px;max-height:520px;overflow-y:auto;" id="historyBody">
      <div class="history-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <p>No reports yet. Run a test to generate the first one.</p>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:space-between;">
      <span style="font-size:0.75rem;color:var(--text-secondary);" id="historyCount"></span>
      <button class="btn btn-secondary" onclick="closeModal('historyModal')">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Failure Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="failureModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h3><span class="badge badge-failed" style="margin-right:8px"><span class="badge-dot"></span>Failed</span><span id="failModalTitle">Test failed</span></h3>
      <button class="modal-close" onclick="closeModal('failureModal')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="ai-summary">
        <div class="ai-summary-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l1.88 5.76a1 1 0 00.95.69H21l-4.94 3.6a1 1 0 00-.36 1.12L17.58 20 12 16.24 6.42 20l1.88-5.83a1 1 0 00-.36-1.12L3 9.45h6.17a1 1 0 00.95-.69L12 3z"/></svg>
        </div>
        <div class="ai-summary-text" id="aiErrorSummary"></div>
      </div>
      <div style="background:var(--bg-app);border:1px solid var(--border);border-radius:8px;padding:14px;font-family:'SF Mono','Fira Code',monospace;font-size:0.75rem;color:var(--error);line-height:1.8;margin-bottom:16px" id="stackTrace"></div>
      <div class="trace-row">
        <div class="trace-pill"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>View Trace</div>
        <div class="trace-pill"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Download Trace</div>
        <div class="trace-pill"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>Replay Video</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('failureModal')">Close</button>
      <button class="btn btn-primary" onclick="closeModal('failureModal');window.location.href='codegen.html'">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>
        Re-record this Step
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ Run Configuration Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="varsModal" onclick="if(event.target===this)closeModal('varsModal')">
  <div class="modal" style="max-width:500px;">
    <div class="modal-header">
      <h3 style="display:flex;align-items:center;gap:8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Run Configuration
      </h3>
      <button class="modal-close" onclick="closeModal('varsModal')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" id="varsModalBody" style="max-height:60vh;overflow-y:auto;display:flex;flex-direction:column;gap:20px;">
      <!-- Injected by showVarsModal() -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('varsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmRunWithVars()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M5 3l14 9-14 9V3z"/></svg>
        Run Tests
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ Edit Test Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Edit Test</h3>
      <button class="modal-close" onclick="closeModal('editModal')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px">
      <div class="form-group">
        <label class="form-label">Test Name</label>
        <input class="form-input" id="editName" type="text" />
      </div>
      <div class="form-group">
        <label class="form-label">Suite File</label>
        <input class="form-input" id="editSuite" type="text" />
      </div>
      <div class="form-group">
        <label class="form-label">Browser</label>
        <select class="form-select" id="editBrowser">
          <option>Chrome + Firefox</option><option>Chrome</option><option>Firefox</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<script>
/* â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SERVER = 'http://localhost:3001';

/* â”€â”€ Test data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// real:true  â†’ test ID is known to the server and can be executed
// real:false â†’ placeholder / not yet implemented spec
const TESTS = [
  { id:1, name:'Search by book title',        suite:'search.spec.ts',   status:'passed',  browser:'Chromium',           duration:'5.6s',  lastRun:'Today, 14:32', real:true  },
  { id:2, name:'Invalid credentials error',   suite:'login.spec.ts',    status:'passed',  browser:'Chromium',           duration:'9.3s',  lastRun:'Today, 14:32', real:true  },
  { id:3, name:'Login with valid credentials',suite:'login.spec.ts',    status:'passed',  browser:'Chromium',           duration:'13.9s', lastRun:'Today, 14:32', real:true  },
  { id:4, name:'Add book to cart',            suite:'cart.spec.ts',     status:'failed',  browser:'Chromium',           duration:'8.1s',  lastRun:'Today, 13:15', real:false },
  { id:5, name:'Checkout flow',               suite:'checkout.spec.ts', status:'running', browser:'Firefox',            duration:'â€”',     lastRun:'Today, 14:35', real:false },
  { id:6, name:'Book category navigation',    suite:'nav.spec.ts',      status:'passed',  browser:'Chromium + Firefox', duration:'4.2s',  lastRun:'Today, 12:00', real:false },
  { id:7, name:'Search result pagination',    suite:'search.spec.ts',   status:'flaky',   browser:'Chromium',           duration:'7.8s',  lastRun:'Today, 11:45', real:false },
  { id:8, name:'Add to wishlist',             suite:'wishlist.spec.ts', status:'failed',  browser:'Firefox',            duration:'6.3s',  lastRun:'Today, 11:30', real:false },
];

const ERRORS = {
  4: { title:'Add book to cart', summary:'<span class="ai-summary-label">âœ¦ AI Error Summary</span>The "Add to Cart" button was blocked by the sticky navigation overlay. The header\'s mega-menu expanded over the button and intercepted all pointer events. <strong>Fix:</strong> add <code>page.keyboard.press("Escape")</code> before clicking the cart button to dismiss the menu.', stack:'TimeoutError: locator.click timeout 15000ms exceeded\n  at CartPage.addToCart (pages/cart-page.ts:24)\n  at tests/cart.spec.ts:18\nExpected: clickable\nReceived: intercepted by .cabecera overlay' },
  8: { title:'Add to wishlist', summary:'<span class="ai-summary-label">âœ¦ AI Error Summary</span>The wishlist icon was not found on the page. The selector <code>[data-test="wishlist-btn"]</code> returned 0 elements. This is likely a self-healing scenario â€” the element\'s test attribute may have changed. <strong>Fix:</strong> use a role-based selector or run the AI locator repair.', stack:'ElementNotFoundError: [data-test="wishlist-btn"]\n  at WishlistPage.add (pages/wishlist-page.ts:14)\n  at tests/wishlist.spec.ts:22\nExpected: visible\nReceived: not found (0 elements)' },
};

let currentFilter = 'all';
let selectedIds   = new Set();
let editingId     = null;
let activeSource  = null; // current EventSource

/* â”€â”€ Status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function statusBadge(s) {
  const map    = { passed:'badge-passed', failed:'badge-failed', running:'badge-running', flaky:'badge-flaky', skipped:'badge-skipped' };
  const labels = { passed:'Passed', failed:'Failed', running:'Running', flaky:'Flaky', skipped:'Skipped' };
  return `<span class="badge ${map[s] || ''}"><span class="badge-dot"></span>${labels[s] || s}</span>`;
}

/* â”€â”€ Actions column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function actionsMenu(t) {
  if (t.status === 'failed') {
    return `<div style="display:flex;gap:6px">
      ${t.real ? `<button class="btn btn-secondary btn-sm" onclick="runOne(${t.id})">Run</button>` : ''}
      <button class="btn btn-danger btn-sm" onclick="openFailure(${t.id})">Inspect</button>
      <button class="btn btn-ghost btn-sm" onclick="openEdit(${t.id})">Edit</button>
    </div>`;
  }
  if (t.status === 'running') {
    return `<button class="btn btn-secondary btn-sm" onclick="stopRun()">Stop</button>`;
  }
  return `<div style="display:flex;gap:6px">
    ${t.real
      ? `<button class="btn btn-secondary btn-sm" onclick="runOne(${t.id})">
           <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M5 3l14 9-14 9V3z"/></svg> Run
         </button>`
      : `<button class="btn btn-ghost btn-sm" title="No spec implemented yet" style="opacity:.4;cursor:default">Run</button>`
    }
    <button class="btn btn-ghost btn-sm" onclick="openEdit(${t.id})">Edit</button>
    <button class="btn btn-danger btn-sm" onclick="deleteTest(${t.id})">Delete</button>
  </div>`;
}

/* â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function render() {
  const search   = document.getElementById('searchInput').value.toLowerCase();
  const filtered = TESTS.filter(t => {
    if (currentFilter !== 'all' && t.status !== currentFilter) return false;
    if (search && !t.name.toLowerCase().includes(search) && !t.suite.toLowerCase().includes(search)) return false;
    return true;
  });
  const tbody = document.getElementById('testsBody');
  tbody.innerHTML = filtered.map(t => `
    <tr data-id="${t.id}" data-status="${t.status}" style="${
      t.status === 'running' ? 'background:var(--running-light);' :
      t.status === 'failed'  ? 'background:var(--error-light);'  : ''}">
      <td><input type="checkbox" class="row-check" onchange="toggleRow(${t.id},this)" ${selectedIds.has(t.id) ? 'checked' : ''}></td>
      <td class="td-label">${t.name}${t.status === 'flaky'
        ? '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2.5" style="margin-left:6px;vertical-align:middle"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
        : ''}
      </td>
      <td class="td-mono">${t.suite}</td>
      <td>${statusBadge(t.status)}</td>
      <td class="td-secondary">${t.browser}</td>
      <td class="td-mono">${t.duration}</td>
      <td class="td-secondary">${t.lastRun}</td>
      <td>${actionsMenu(t)}</td>
    </tr>
  `).join('') || `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-secondary);font-size:0.85rem">No tests match your filters.</td></tr>`;

  // update filter counts
  ['passed','failed','running','flaky'].forEach(s => {
    const el = document.getElementById('count-' + s);
    if (el) el.textContent = TESTS.filter(t => t.status === s).length;
  });
  const allEl = document.getElementById('count-all');
  if (allEl) allEl.textContent = TESTS.length;
}

/* â”€â”€ Filtering / selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function filterTests() { render(); }
function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  render();
}
function toggleAll(cb) {
  document.querySelectorAll('#testsBody [type=checkbox]').forEach(c => {
    c.checked = cb.checked;
    const id = parseInt(c.closest('tr').dataset.id);
    cb.checked ? selectedIds.add(id) : selectedIds.delete(id);
  });
  updateBulkBar();
}
function toggleRow(id, cb) { cb.checked ? selectedIds.add(id) : selectedIds.delete(id); updateBulkBar(); }
function updateBulkBar() {
  document.getElementById('bulkBar').style.display = selectedIds.size > 0 ? 'flex' : 'none';
  document.getElementById('bulkCount').textContent = `${selectedIds.size} selected`;
}
function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll('.row-check').forEach(c => c.checked = false);
  updateBulkBar();
}

/* â”€â”€ Run entry points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function runSelected() {
  if (!selectedIds.size) { showToast('Select at least one test first.', 'warn'); return; }
  startRunFlow([...selectedIds]);
}
function bulkRun() { startRunFlow([...selectedIds]); clearSelection(); }
function runOne(id) { startRunFlow([id]); }

/* â”€â”€ Check for configurable variables, then run or show modal  */
function startRunFlow(ids) {
  const varGroups = ids
    .map(id => TESTS.find(t => t.id === id))
    .filter(t => t?.variables?.length)
    .map(t => ({ testId: t.id, testName: t.name, variables: t.variables }));

  if (!varGroups.length) { openTerminalAndRun(ids, {}); return; }
  showVarsModal(ids, varGroups);
}

/* â”€â”€ Run Configuration modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _pendingRunIds    = [];
let _pendingVarGroups = [];

function resetVarInput(key) {
  const defaultVal = _pendingVarGroups.flatMap(g => g.variables).find(v => v.key === key)?.default || '';
  const el = document.getElementById('varInput-' + key);
  if (el) el.value = defaultVal;
}

function showVarsModal(ids, varGroups) {
  _pendingRunIds    = ids;
  _pendingVarGroups = varGroups;

  // Deduplicate variables by key across tests (same key â†’ one input)
  const seen = new Set();
  const body = document.getElementById('varsModalBody');
  body.innerHTML = varGroups.map(group => {
    const uniqueVars = group.variables.filter(v => { if (seen.has(v.key)) return false; seen.add(v.key); return true; });
    if (!uniqueVars.length) return '';
    return `
      <div>
        <div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;
                    color:var(--text-secondary);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);">
          ${escHtml(group.testName)}
        </div>
        <div style="display:flex;flex-direction:column;gap:14px;">
          ${uniqueVars.map(v => `
            <div>
              <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px;">
                <label style="font-size:0.8rem;font-weight:600;color:var(--text-primary);">${escHtml(v.label)}</label>
                ${v.default ? `<button type="button" onclick="resetVarInput('${v.key}')"
                    style="font-size:0.68rem;color:var(--accent);background:none;border:none;cursor:pointer;padding:0;">
                    Reset to default</button>` : ''}
              </div>
              ${v.description ? `<div style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:6px;">${escHtml(v.description)}</div>` : ''}
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="${v.type === 'password' ? 'password' : v.type === 'email' ? 'email' : 'text'}"
                  class="form-input" id="varInput-${v.key}" data-key="${v.key}"
                  value="${escHtml(v.default || '')}"
                  placeholder="${v.type === 'password' ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'Enter valueâ€¦'}"
                  style="flex:1;" />
                ${v.type === 'password' ? `
                  <button type="button" title="Show / hide password"
                    onclick="const i=document.getElementById('varInput-${v.key}');i.type=i.type==='password'?'text':'password';"
                    style="background:none;border:1px solid var(--border);border-radius:var(--radius-sm);
                           padding:6px 8px;cursor:pointer;color:var(--text-secondary);line-height:0;flex-shrink:0;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>`;
  }).join('');

  document.getElementById('varsModal').classList.add('open');
}

function confirmRunWithVars() {
  const vars = {};
  const seen = new Set();
  _pendingVarGroups.forEach(group => {
    group.variables.forEach(v => {
      if (seen.has(v.key)) return;
      seen.add(v.key);
      const el = document.getElementById('varInput-' + v.key);
      if (el) vars[v.key] = el.value;
    });
  });
  closeModal('varsModal');
  openTerminalAndRun(_pendingRunIds, vars);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CORE: open the terminal modal and stream from the server
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openTerminalAndRun(ids, vars = {}) {
  // Separate real vs mock
  const realIds = ids.filter(id => TESTS.find(t => t.id === id)?.real);
  const mockIds = ids.filter(id => !TESTS.find(t => t.id === id)?.real);

  // Open the modal
  const modal = document.getElementById('terminalModal');
  modal.classList.add('open');

  // Reset UI
  const output   = document.getElementById('terminalOutput');
  const title    = document.getElementById('terminalTitle');
  const spinner  = document.getElementById('terminalSpinner');
  const badge    = document.getElementById('terminalResultBadge');
  const badgeTxt = document.getElementById('terminalResultText');
  const reportBtn = document.getElementById('terminalReportBtn');

  output.innerHTML = '';
  reportBtn.style.display = 'none';
  badge.className = 'terminal-result-badge running';
  spinner.style.display = '';

  const names = ids.map(id => TESTS.find(t => t.id === id)?.name || `#${id}`);
  title.textContent = names.length === 1 ? `Running: ${names[0]}` : `Running ${names.length} tests`;

  // Warn about mock tests immediately
  if (mockIds.length) {
    const mockNames = mockIds.map(id => TESTS.find(t => t.id === id)?.name || `#${id}`).join(', ');
    appendLine(`âš   Mock tests (no spec yet): ${mockNames}\n`, 'warn');
  }

  if (!realIds.length) {
    appendLine('\nNo real Playwright specs selected.\nOnly tests 1â€“3 can be executed.\n', 'warn');
    finishRun([], true);
    return;
  }

  // Close any previous EventSource
  if (activeSource) { activeSource.close(); activeSource = null; }

  const urlVars = Object.keys(vars).length ? '&vars=' + encodeURIComponent(JSON.stringify(vars)) : '';
  const url = `${SERVER}/api/run?ids=${realIds.join(',')}${urlVars}`;
  const es  = new EventSource(url);
  activeSource = es;

  es.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'line') {
      appendLine(data.text, data.level);
    }

    if (data.type === 'start') {
      // Mark that test row as "running"
      setTestStatus(data.id, 'running', 'â€”');
    }

    if (data.type === 'result') {
      // Update the in-memory data and re-render the row
      const now = new Date();
      const timeStr = now.toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' });
      setTestStatus(data.id, data.passed ? 'passed' : 'failed', data.duration, `Today, ${timeStr}`);
    }

    if (data.type === 'done') {
      es.close();
      activeSource = null;
      if (data.reportId) currentReportId = data.reportId;
      finishRun(data.results || [], false);
    }
  };

  es.onerror = () => {
    es.close();
    activeSource = null;
    appendLine('\nâš   Connection to server lost.\n   Make sure the server is running:  npm run ui\n', 'error');
    finishRun([], true);
  };
}

/* â”€â”€ Append a line to the terminal output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function appendLine(text, level = 'normal') {
  const output = document.getElementById('terminalOutput');
  const div    = document.createElement('div');
  div.className = 'terminal-line ' + (level || 'normal');
  div.textContent = text;
  output.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

/* â”€â”€ Update a test row after it runs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setTestStatus(id, status, duration, lastRun) {
  const t = TESTS.find(t => t.id === id);
  if (!t) return;
  t.status = status;
  if (duration) t.duration = duration;
  if (lastRun)  t.lastRun  = lastRun;
  render();
}

/* â”€â”€ Show run complete state in the modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function finishRun(results, hadError) {
  const spinner  = document.getElementById('terminalSpinner');
  const badge    = document.getElementById('terminalResultBadge');
  const badgeTxt = document.getElementById('terminalResultText');
  const reportBtn = document.getElementById('terminalReportBtn');

  spinner.style.display = 'none';

  if (hadError || !results.length) {
    badge.className = 'terminal-result-badge failed';
    badgeTxt.textContent = hadError ? 'Error â€” could not connect to server.' : 'Finished';
    return;
  }

  const passed = results.filter(r => r.passed).length;
  const failed = results.length - passed;
  const allOk  = failed === 0;

  badge.className   = `terminal-result-badge ${allOk ? 'passed' : 'failed'}`;
  badgeTxt.textContent = allOk
    ? `${passed} passed`
    : `${failed} failed, ${passed} passed`;

  reportBtn.style.display = '';

  appendLine(`\n${'â•'.repeat(56)}`, 'normal');
  appendLine(allOk
    ? `  All ${passed} test${passed > 1 ? 's' : ''} passed.`
    : `  ${failed} failed Â· ${passed} passed`, allOk ? 'success' : 'error');
}

/* â”€â”€ Cancel / close terminal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function cancelRun() {
  if (activeSource) { activeSource.close(); activeSource = null; }
  closeTerminal();
}

/* â”€â”€ Stop an in-progress run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function stopRun() {
  if (!activeSource) {
    showToast('No active run to stop.', 'warn');
    return;
  }
  activeSource.close();
  activeSource = null;

  appendLine('\nâ¹  Run stopped by user.\n', 'warn');
  document.getElementById('terminalSpinner').style.display = 'none';
  const badge    = document.getElementById('terminalResultBadge');
  const badgeTxt = document.getElementById('terminalResultText');
  badge.className      = 'terminal-result-badge failed';
  badgeTxt.textContent = 'Stopped';

  // Reset any tests still marked as "running" back to failed
  TESTS.forEach(t => { if (t.status === 'running') t.status = 'failed'; });
  render();
}
function closeTerminal() {
  document.getElementById('terminalModal').classList.remove('open');
}
function openReport() {
  const url = currentReportId
    ? `${SERVER}/reports/${currentReportId}/html/index.html`
    : `${SERVER}/playwright-report/index.html`;
  window.open(url, '_blank');
}

/* â”€â”€ Other modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openFailure(id) {
  const e = ERRORS[id];
  if (!e) return;
  document.getElementById('failModalTitle').textContent = e.title;
  document.getElementById('aiErrorSummary').innerHTML  = e.summary;
  document.getElementById('stackTrace').innerHTML      = e.stack.replace(/\n/g, '<br>');
  document.getElementById('failureModal').classList.add('open');
}
function openEdit(id) {
  const t = TESTS.find(t => t.id === id);
  if (!t) return;
  editingId = id;
  document.getElementById('editName').value  = t.name;
  document.getElementById('editSuite').value = t.suite;
  document.getElementById('editModal').classList.add('open');
}
function saveEdit() {
  const t = TESTS.find(t => t.id === editingId);
  if (t) {
    t.name  = document.getElementById('editName').value;
    t.suite = document.getElementById('editSuite').value;
  }
  closeModal('editModal');
  render();
}
function closeModal(id)  { document.getElementById(id).classList.remove('open'); }
function deleteTest(id)  {
  if (!confirm('Delete this test?')) return;
  const idx = TESTS.findIndex(t => t.id === id);
  if (idx > -1) { TESTS.splice(idx, 1); selectedIds.delete(id); render(); }
}
function bulkDelete()    { if (confirm(`Delete ${selectedIds.size} test(s)?`)) { selectedIds.forEach(id => deleteTest(id)); } }

/* â”€â”€ Close modals on overlay click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === e.currentTarget) {
      if (m.id === 'terminalModal') cancelRun();
      else closeModal(m.id);
    }
  });
});

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(msg, type) {
  const t = document.createElement('div');
  const bg = { success:'var(--success)', error:'var(--error)', warn:'var(--warning)', info:'var(--accent)' };
  t.style.cssText = `position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:8px;font-size:0.8rem;font-weight:600;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.15);max-width:340px;`;
  t.style.background = bg[type] || bg.info;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

/* â”€â”€ Report History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentReportId = null; // set by the 'done' SSE event

async function openHistory() {
  document.getElementById('historyModal').classList.add('open');
  const body = document.getElementById('historyBody');
  body.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-secondary);font-size:0.82rem;">Loadingâ€¦</p>';

  let reports = [];
  try {
    const res = await fetch(`${SERVER}/api/reports`);
    reports = await res.json();
  } catch {
    body.innerHTML = '<p style="text-align:center;padding:20px;color:var(--error);font-size:0.82rem;">Could not reach server.</p>';
    return;
  }

  document.getElementById('historyCount').textContent =
    reports.length ? `${reports.length} report${reports.length > 1 ? 's' : ''} stored` : '';

  if (!reports.length) {
    body.innerHTML = `<div class="history-empty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <p>No reports yet. Run a test to generate the first one.</p>
    </div>`;
    return;
  }

  body.innerHTML = reports.map(r => {
    const date    = new Date(r.timestamp);
    const isToday = date.toDateString() === new Date().toDateString();
    const timeStr = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const dateStr = isToday
      ? `Today Â· ${timeStr}`
      : `${date.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })} Â· ${timeStr}`;
    const totalSec = r.totalMs ? (r.totalMs / 1000).toFixed(1) + 's' : 'â€”';

    const pills = r.results.map(res => `
      <span class="report-result-pill ${res.passed ? 'passed' : 'failed'}">
        ${res.passed
          ? '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>'
          : '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'}
        ${escHtml(res.label)}
        <span style="opacity:0.6;font-weight:400">${res.duration}</span>
      </span>`).join('');

    const overallBadge = r.allPassed
      ? `<span class="badge badge-passed"><span class="badge-dot"></span>All passed</span>`
      : `<span class="badge badge-failed"><span class="badge-dot"></span>Failed</span>`;

    const openBtn = r.hasHtml
      ? `<button class="btn btn-secondary btn-sm" onclick="window.open('${SERVER}/reports/${r.id}/html/index.html','_blank')">
           <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
           Open Report
         </button>`
      : `<span style="font-size:0.72rem;color:var(--text-disabled);">No HTML report</span>`;

    return `<div class="report-card" id="rcard-${r.id}">
      <div class="report-card-header">
        <div style="display:flex;align-items:center;gap:8px;">
          ${overallBadge}
          <span class="report-card-meta">${dateStr}</span>
        </div>
        <span class="report-card-meta">Total: ${totalSec}</span>
      </div>
      <div class="report-card-results">${pills}</div>
      <div class="report-card-footer">
        ${openBtn}
        <button class="btn btn-ghost btn-sm" style="color:var(--error);" onclick="deleteReport('${r.id}')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
          Delete
        </button>
      </div>
    </div>`;
  }).join('');
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function deleteReport(id) {
  if (!confirm('Delete this report? The HTML files will be permanently removed.')) return;
  try {
    await fetch(`${SERVER}/api/reports/${id}`, { method: 'DELETE' });
    document.getElementById(`rcard-${id}`)?.remove();
    // Refresh count
    const remaining = document.querySelectorAll('.report-card').length;
    document.getElementById('historyCount').textContent =
      remaining ? `${remaining} report${remaining > 1 ? 's' : ''} stored` : '';
    if (!remaining) {
      document.getElementById('historyBody').innerHTML = `<div class="history-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <p>No reports yet. Run a test to generate the first one.</p>
      </div>`;
    }
  } catch {
    showToast('Could not delete report.', 'error');
  }
}

/* â”€â”€ Initial render (fetch variable defs from server first) â”€â”€ */
async function init() {
  try {
    const res = await fetch(`${SERVER}/api/tests`);
    const serverTests = await res.json();
    serverTests.forEach(st => {
      const t = TESTS.find(t => t.id === st.id);
      if (t && st.variables?.length) t.variables = st.variables;
    });
  } catch { /* server offline â€” tests run without variable config */ }
  render();
}
init();
</script>
</body>
</html>

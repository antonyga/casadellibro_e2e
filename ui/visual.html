<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <title>TestPilot — Visual Tests</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* ── Visual-page specific ─────────────────────────────── */
    .visual-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 0;
      height: calc(100vh - var(--topbar-h));
      overflow: hidden;
    }

    /* Left panel — test list */
    .visual-list-panel {
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--bg-surface);
      overflow: hidden;
    }
    .visual-list-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .visual-list-header h3 { font-size: 0.9rem; }
    .visual-list-scroll { flex: 1; overflow-y: auto; padding: 8px; }

    .visual-item {
      padding: 10px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: 1.5px solid transparent;
      margin-bottom: 4px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .visual-item:hover { background: var(--bg-app); }
    .visual-item.active {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    .visual-item-thumb {
      width: 44px;
      height: 32px;
      border-radius: 4px;
      overflow: hidden;
      background: var(--bg-app);
      border: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-disabled);
      font-size: 10px;
    }
    .visual-item-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .visual-item-thumb svg { width: 16px; height: 16px; }
    .visual-item-info { flex: 1; min-width: 0; }
    .visual-item-name {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .visual-item-meta {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 1px;
    }
    .diff-pill {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 99px;
      flex-shrink: 0;
      letter-spacing: 0.01em;
    }
    .diff-pill.none    { background: var(--success-light); color: var(--success); }
    .diff-pill.low     { background: var(--warning-light); color: var(--warning); }
    .diff-pill.high    { background: var(--error-light);   color: var(--error); }
    .diff-pill.new-tag { background: var(--running-light); color: var(--running); }

    /* Right panel — compare view */
    .visual-compare-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-app);
      overflow: hidden;
    }
    .compare-toolbar {
      padding: 12px 20px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .compare-info { display: flex; flex-direction: column; gap: 2px; }
    .compare-title { font-size: 0.9rem; font-weight: 700; font-family: var(--font-heading); }
    .compare-meta { font-size: 0.72rem; color: var(--text-secondary); }
    .compare-actions { display: flex; align-items: center; gap: 8px; }

    /* View-mode tabs */
    .view-tabs {
      display: flex;
      background: var(--bg-app);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 2px;
      gap: 2px;
    }
    .view-tab {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      transition: all 0.15s;
      cursor: pointer;
    }
    .view-tab.active {
      background: var(--bg-surface);
      color: var(--text-primary);
      box-shadow: var(--shadow-xs);
    }

    /* Swipe container */
    .compare-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 16px;
      overflow-y: auto;
    }

    .swipe-wrapper {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: #1a1a2e;
      box-shadow: var(--shadow-lg);
      aspect-ratio: 16/9;
      user-select: none;
    }

    /* Image panes */
    .swipe-pane {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }
    .swipe-pane.actual-pane {
      clip-path: inset(0 0 0 50%);
      transition: clip-path 0.01s;
    }
    .swipe-pane img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .pane-placeholder {
      width: 100%;
      height: 100%;
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #4a5568;
    }
    .pane-placeholder svg { opacity: 0.4; }
    .pane-placeholder span { font-size: 0.72rem; }

    /* Divider line + handle */
    .swipe-divider {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 100%;
      background: #fff;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 10;
    }
    .swipe-handle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 11;
    }
    .swipe-handle svg { color: #374151; }

    /* Labels */
    .swipe-label {
      position: absolute;
      top: 12px;
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
      z-index: 12;
      pointer-events: none;
    }
    .swipe-label-baseline { left: 12px; background: rgba(0,0,0,0.5); color: #fff; }
    .swipe-label-actual   { right: 12px; background: rgba(239,68,68,0.8); color: #fff; }

    /* Range slider overlay */
    .swipe-range {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: ew-resize;
      z-index: 20;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
    }

    /* Side-by-side view */
    .sidebyside-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .sbs-pane {
      border-radius: var(--radius-md);
      overflow: hidden;
      background: #1a1a2e;
    }
    .sbs-label {
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #fff;
    }
    .sbs-img {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
      background: #1a1a2e;
    }
    .sbs-img.placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      color: #4a5568;
      font-size: 0.72rem;
    }

    /* Diff highlights view */
    .diff-view {
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: #1a1a2e;
      position: relative;
    }
    .diff-view-img {
      width: 100%;
      display: block;
      aspect-ratio: 16/9;
      object-fit: cover;
    }

    /* Diff stats bar */
    .diff-stats {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .diff-stat { display: flex; flex-direction: column; gap: 2px; }
    .diff-stat-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); font-weight: 600; }
    .diff-stat-value { font-size: 1.05rem; font-weight: 700; font-family: var(--font-heading); }
    .diff-stat-value.error   { color: var(--error); }
    .diff-stat-value.warning { color: var(--warning); }
    .diff-stat-value.success { color: var(--success); }
    .diff-divider { width: 1px; height: 32px; background: var(--border); }

    .diff-progress-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-app);
      border-radius: 99px;
      overflow: hidden;
    }
    .diff-progress-fill {
      height: 100%;
      border-radius: 99px;
      background: var(--error);
      transition: width 0.4s ease;
    }

    /* Approve / Reject */
    .btn-approve {
      background: var(--success);
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: opacity 0.15s;
      cursor: pointer;
    }
    .btn-approve:hover { opacity: 0.88; }
    .btn-reject {
      background: var(--error-light);
      color: var(--error);
      border: 1px solid var(--error);
      padding: 8px 18px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      cursor: pointer;
    }
    .btn-reject:hover { background: var(--error); color: #fff; }

    /* Empty state */
    .compare-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-secondary);
    }
    .compare-empty svg { width: 40px; height: 40px; opacity: 0.3; }
    .compare-empty p { font-size: 0.85rem; }

    /* Status banners */
    .approved-banner {
      background: var(--success-light);
      border: 1px solid var(--success);
      border-radius: var(--radius-md);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--success);
    }
    .new-banner {
      background: var(--running-light);
      border: 1px solid var(--running);
      border-radius: var(--radius-md);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--running);
    }

    /* Visual run modal */
    .vrun-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }
    .vrun-overlay.active { display: flex; }
    .vrun-modal {
      background: #0f172a;
      border-radius: 12px;
      width: 700px;
      max-width: 92vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 48px rgba(0,0,0,0.5);
    }
    .vrun-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .vrun-header-title {
      color: #f1f5f9;
      font-weight: 700;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .vrun-output {
      flex: 1;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.72rem;
      line-height: 1.65;
      background: #0a0f1a;
      padding: 16px;
      white-space: pre-wrap;
      color: #94a3b8;
      min-height: 200px;
      max-height: 400px;
    }
    .vrun-output .line-success { color: #34d399; }
    .vrun-output .line-error   { color: #f87171; }
    .vrun-output .line-warn    { color: #fbbf24; }
    .vrun-output .line-info    { color: #60a5fa; }
    .vrun-footer {
      padding: 12px 20px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .vrun-status { color: #94a3b8; font-size: 0.75rem; }
    .dot-pulse {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .dot-pulse span {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--running);
      animation: dotBounce 1.2s ease-in-out infinite;
    }
    .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
    .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotBounce {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* List loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-app) 25%, var(--border) 50%, var(--bg-app) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 6px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/></svg>
    <span class="logo-text">TestPilot</span><span class="logo-badge">BETA</span>
  </div>
  <nav class="sidebar-nav">
    <span class="nav-section-label">Overview</span>
    <a href="index.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span>Dashboard</span>
    </a>
    <a href="tests.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 3H9.5L9 7.5c0 .5-.5 1-1 1H4a1 1 0 00-1 1V21a1 1 0 001 1h16a1 1 0 001-1V9.5a1 1 0 00-1-1h-4c-.5 0-1-.5-1-1L14.5 3z"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
      <span>Test Suites</span><span class="nav-badge">2</span>
    </a>
    <span class="nav-section-label">Tools</span>
    <a href="codegen.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3l1.88 5.76a1 1 0 00.95.69H21l-4.94 3.6a1 1 0 00-.36 1.12L17.58 20 12 16.24 6.42 20l1.88-5.83a1 1 0 00-.36-1.12L3 9.45h6.17a1 1 0 00.95-.69L12 3z"/></svg>
      <span>AI Generator</span>
    </a>
    <a href="visual.html" class="nav-item active">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      <span>Visual Tests</span>
    </a>
    <span class="nav-section-label">Config</span>
    <a href="settings.html" class="nav-item">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      <span>Settings</span>
    </a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-profile">
      <div class="avatar">QA</div>
      <div class="user-info"><span class="user-name">QA Engineer</span><span class="user-role">casadellibro.com</span></div>
    </div>
  </div>
</aside>

<div class="main-layout">
  <header class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">Visual Tests</h1>
      <div class="breadcrumb"><span>casadellibro.com</span><span>/</span><span class="crumb-current">Visual Tests</span></div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-secondary btn-sm" onclick="runVisualTests(true)" title="Re-capture all screenshots as new baselines">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 2v6h-6M3 12a9 9 0 0115-6.7L21 8M3 22v-6h6M21 12a9 9 0 01-15 6.7L3 16"/></svg>
        Update Baselines
      </button>
      <button class="btn btn-secondary btn-sm" onclick="runVisualTests(false)" id="runBtn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M10 8l6 4-6 4V8z" fill="currentColor" stroke="none"/></svg>
        Run Visual Tests
      </button>
      <button class="btn btn-primary btn-sm" onclick="approveAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
        Approve All Diffs
      </button>
    </div>
  </header>

  <main class="content" style="padding:0; overflow:hidden; height:calc(100vh - var(--topbar-h));">
    <div class="visual-layout">

      <!-- LEFT: Snapshot list -->
      <div class="visual-list-panel">
        <div class="visual-list-header">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <h3>Snapshots</h3>
            <span id="diffCountBadge" style="font-size:0.72rem;color:var(--text-secondary);">—</span>
          </div>
          <div class="search-bar" style="--height:32px;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="filterInput" placeholder="Filter snapshots…" style="font-size:0.78rem;" oninput="applyFilter()" />
          </div>
          <div id="summaryBadges" style="display:flex;gap:8px;">
            <span class="badge" style="font-size:0.67rem;background:var(--bg-app);color:var(--text-secondary);border:1px solid var(--border);">Loading…</span>
          </div>
        </div>
        <div class="visual-list-scroll" id="visualList">
          <!-- Skeleton loading -->
          <div id="listSkeleton">
            <div class="skeleton" style="height:52px;margin-bottom:4px;border-radius:8px;"></div>
            <div class="skeleton" style="height:52px;margin-bottom:4px;border-radius:8px;opacity:0.7;"></div>
            <div class="skeleton" style="height:52px;margin-bottom:4px;border-radius:8px;opacity:0.4;"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Compare panel -->
      <div class="visual-compare-panel" id="comparePanel">

        <div class="compare-toolbar">
          <div class="compare-info">
            <span class="compare-title" id="compareTitle">Select a snapshot</span>
            <span class="compare-meta" id="compareMeta">Click an item on the left to compare</span>
          </div>
          <div class="compare-actions">
            <div class="view-tabs">
              <button class="view-tab active" onclick="setViewMode('swipe',this)">Swipe</button>
              <button class="view-tab" onclick="setViewMode('side',this)">Side by Side</button>
              <button class="view-tab" onclick="setViewMode('diff',this)">Diff Image</button>
            </div>
            <button class="btn-reject" id="rejectBtn" onclick="rejectCurrent()" style="display:none;">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              Reject
            </button>
            <button class="btn-approve" id="approveBtn" onclick="approveCurrent()" style="display:none;">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
              <span id="approveBtnLabel">Approve</span>
            </button>
          </div>
        </div>

        <div class="compare-body" id="compareBody">

          <!-- ── SWIPE VIEW (default) ── -->
          <div id="swipeView">
            <div class="swipe-wrapper" id="swipeWrap">
              <!-- Baseline pane -->
              <div class="swipe-pane baseline-pane" id="baselinePane">
                <div class="pane-placeholder" id="baselinePlaceholder">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                  <span>No baseline</span>
                </div>
                <img id="swipeBaselineImg" alt="Baseline" style="display:none;width:100%;height:100%;object-fit:cover;" />
              </div>
              <!-- Actual pane -->
              <div class="swipe-pane actual-pane" id="actualPane">
                <div class="pane-placeholder" id="actualPlaceholder">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                  <span>No actual</span>
                </div>
                <img id="swipeActualImg" alt="Actual" style="display:none;width:100%;height:100%;object-fit:cover;" />
              </div>
              <!-- Divider -->
              <div class="swipe-divider" id="swipeDivider"></div>
              <div class="swipe-handle" id="swipeHandle">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/><polyline points="12 19 5 12 12 5"/></svg>
              </div>
              <!-- Labels -->
              <span class="swipe-label swipe-label-baseline">Baseline</span>
              <span class="swipe-label swipe-label-actual">Actual</span>
              <!-- Range slider -->
              <input type="range" class="swipe-range" id="swipeRange" min="0" max="100" value="50" oninput="onSwipe(this.value)" />
            </div>
            <p style="text-align:center;font-size:0.72rem;color:var(--text-secondary);margin-top:6px;">
              Drag the slider to compare baseline vs. actual screenshot
            </p>
          </div>

          <!-- ── SIDE BY SIDE VIEW ── -->
          <div id="sideView" style="display:none;">
            <div class="sidebyside-view">
              <div class="sbs-pane">
                <div class="sbs-label">Expected (Baseline)</div>
                <img id="sbsBaselineImg" class="sbs-img" alt="Baseline" />
              </div>
              <div class="sbs-pane">
                <div class="sbs-label" style="background:rgba(239,68,68,0.5);">Actual (Current Run)</div>
                <img id="sbsActualImg" class="sbs-img" alt="Actual" />
              </div>
            </div>
          </div>

          <!-- ── DIFF IMAGE VIEW ── -->
          <div id="diffView" style="display:none;">
            <div class="diff-view">
              <div id="diffImgWrap" style="position:relative;">
                <img id="diffViewImg" class="diff-view-img" alt="Diff" style="display:none;" />
                <div id="diffImgEmpty" class="pane-placeholder" style="aspect-ratio:16/9;position:relative;">
                  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  <span>No diff image — snapshots match</span>
                </div>
              </div>
            </div>
            <p style="font-size:0.72rem;color:var(--text-secondary);margin-top:6px;">
              Playwright's diff image highlights changed pixels in magenta/red.
            </p>
          </div>

          <!-- Diff stats -->
          <div class="diff-stats" id="diffStats" style="display:none;">
            <div class="diff-stat">
              <span class="diff-stat-label">Diff %</span>
              <span class="diff-stat-value" id="statDiff">—</span>
            </div>
            <div class="diff-divider"></div>
            <div class="diff-stat">
              <span class="diff-stat-label">Changed Pixels</span>
              <span class="diff-stat-value" id="statPx">—</span>
            </div>
            <div class="diff-divider"></div>
            <div class="diff-stat">
              <span class="diff-stat-label">Threshold</span>
              <span class="diff-stat-value">0.1%</span>
            </div>
            <div class="diff-divider"></div>
            <div class="diff-stat">
              <span class="diff-stat-label">Capture Time</span>
              <span class="diff-stat-value success" id="statTime">—</span>
            </div>
            <div class="diff-divider"></div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <span style="font-size:0.68rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);font-weight:600;">Pixel coverage</span>
                <span style="font-size:0.72rem;font-weight:700;" id="statCoverage">—</span>
              </div>
              <div class="diff-progress-bar">
                <div class="diff-progress-fill" id="diffFill" style="width:0%"></div>
              </div>
            </div>
          </div>

          <!-- Status banners -->
          <div class="approved-banner" id="approvedBanner" style="display:none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
            Baseline matches — no visual changes detected.
          </div>
          <div class="new-banner" id="newBanner" style="display:none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            New snapshot — no baseline exists yet. Click <strong>Set as Baseline</strong> to approve.
          </div>

          <!-- Empty state (no snapshot selected) -->
          <div class="compare-empty" id="emptyState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <p>Select a snapshot to compare</p>
          </div>

        </div>
      </div>
    </div>
  </main>
</div>

<!-- Visual run terminal modal -->
<div class="vrun-overlay" id="vrunOverlay">
  <div class="vrun-modal">
    <div class="vrun-header">
      <span class="vrun-header-title">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Visual Regression Run
      </span>
      <button onclick="closeVisualRun()" style="color:#94a3b8;background:none;border:none;cursor:pointer;font-size:1.1rem;line-height:1;padding:4px 6px;">✕</button>
    </div>
    <div class="vrun-output" id="vrunOutput"></div>
    <div class="vrun-footer">
      <span class="vrun-status" id="vrunStatus">
        <span class="dot-pulse"><span></span><span></span><span></span></span>
        &nbsp; Running…
      </span>
      <button class="btn btn-sm btn-primary" id="vrunDoneBtn" onclick="closeVisualRun()" style="display:none;">
        Done
      </button>
    </div>
  </div>
</div>

<script>
  /* ── State ─────────────────────────────────────────────── */
  let allSnapshots = [];   // Full list from API
  let currentSnap  = null; // Currently selected snapshot
  let currentView  = 'swipe';
  let vrunES       = null; // Active EventSource for visual run

  /* ── Utilities ──────────────────────────────────────────── */
  function bust(url) { return url ? url + '?t=' + Date.now() : ''; }

  function formatLabel(title) {
    return title
      .replace(/^should capture\s+/i, '')
      .replace(/\s+screenshot$/i, '')
      .split(/\s+/)
      .map(w => w.charAt(0).toUpperCase() + w.slice(1))
      .join(' ');
  }

  function diffPillClass(snap) {
    if (snap.status === 'new')  return 'new-tag';
    if (snap.status === 'pass') return 'none';
    return snap.diffRatio > 0.02 ? 'high' : 'low';
  }

  function diffPillText(snap) {
    if (snap.status === 'new')  return 'NEW';
    if (snap.status === 'pass') return '0%';
    return (snap.diffRatio * 100).toFixed(1) + '%';
  }

  function setImg(imgEl, showEl, src) {
    if (src) {
      imgEl.src = bust(src);
      imgEl.style.display = '';
      if (showEl) showEl.style.display = 'none';
    } else {
      imgEl.src = '';
      imgEl.style.display = 'none';
      if (showEl) showEl.style.display = '';
    }
  }

  /* ── Load & render ──────────────────────────────────────── */
  async function loadSnapshots() {
    try {
      const resp = await fetch('/api/snapshots');
      const data = await resp.json();
      allSnapshots = data.snapshots || [];
      renderList(allSnapshots);
      updateSummary(allSnapshots);
      // Auto-select first diff or first item
      const first = allSnapshots.find(s => s.status === 'diff' || s.status === 'new') || allSnapshots[0];
      if (first) selectSnapshot(first);
    } catch (e) {
      document.getElementById('listSkeleton').innerHTML =
        `<div style="padding:16px;font-size:0.78rem;color:var(--text-secondary);text-align:center;">
          No snapshots found.<br>Click <strong>Run Visual Tests</strong> to capture screenshots.
        </div>`;
      updateSummary([]);
    }
  }

  function updateSummary(snaps) {
    const pass    = snaps.filter(s => s.status === 'pass').length;
    const diffs   = snaps.filter(s => s.status === 'diff').length;
    const newSnap = snaps.filter(s => s.status === 'new').length;
    document.getElementById('diffCountBadge').textContent =
      snaps.length ? `${diffs} diff${diffs !== 1 ? 's' : ''}` : '—';
    const badges = document.getElementById('summaryBadges');
    badges.innerHTML = snaps.length === 0
      ? `<span class="badge" style="font-size:0.67rem;background:var(--bg-app);color:var(--text-secondary);border:1px solid var(--border);">No data</span>`
      : [
          pass    ? `<span class="badge badge-success" style="font-size:0.67rem;">${pass} passed</span>` : '',
          diffs   ? `<span class="badge badge-error"   style="font-size:0.67rem;">${diffs} diff${diffs !== 1 ? 's' : ''}</span>` : '',
          newSnap ? `<span class="badge"               style="font-size:0.67rem;background:var(--running-light);color:var(--running);border:1px solid var(--running);">${newSnap} new</span>` : '',
        ].filter(Boolean).join('');
  }

  function renderList(snaps) {
    const container = document.getElementById('visualList');
    document.getElementById('listSkeleton')?.remove();

    if (!snaps.length) {
      container.innerHTML =
        `<div style="padding:24px 16px;text-align:center;color:var(--text-secondary);font-size:0.8rem;">
          No snapshots yet.<br>Click <strong>Run Visual Tests</strong> to get started.
        </div>`;
      return;
    }

    const iconFor = status => {
      if (status === 'pass') return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="20 6 9 17 4 12"/></svg>`;
      if (status === 'new')  return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;
      return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>`;
    };

    container.innerHTML = snaps.map(snap => {
      const thumbContent = snap.baselineUrl
        ? `<img src="${bust(snap.baselineUrl)}" alt="thumb" loading="lazy" />`
        : iconFor(snap.status);
      const label   = formatLabel(snap.label);
      const pctText = diffPillText(snap);
      const pillCls = diffPillClass(snap);
      const durationS = snap.duration ? (snap.duration / 1000).toFixed(1) + 's' : '—';
      return `
        <div class="visual-item" data-id="${snap.name}" onclick="selectSnapshot(allSnapshots.find(s=>s.name==='${snap.name}'))">
          <div class="visual-item-thumb">${thumbContent}</div>
          <div class="visual-item-info">
            <div class="visual-item-name">${label}</div>
            <div class="visual-item-meta">visual.spec.ts · ${durationS}</div>
          </div>
          <span class="diff-pill ${pillCls}">${pctText}</span>
        </div>`;
    }).join('');
  }

  function applyFilter() {
    const q = document.getElementById('filterInput').value.toLowerCase();
    const filtered = q ? allSnapshots.filter(s => formatLabel(s.label).toLowerCase().includes(q)) : allSnapshots;
    renderList(filtered);
  }

  /* ── Select a snapshot ───────────────────────────────────── */
  function selectSnapshot(snap) {
    if (!snap) return;
    currentSnap = snap;

    document.querySelectorAll('.visual-item').forEach(el => {
      el.classList.toggle('active', el.dataset.id === snap.name);
    });

    const label       = formatLabel(snap.label);
    const pct         = (snap.diffRatio * 100).toFixed(1);
    const durationS   = snap.duration ? (snap.duration / 1000).toFixed(1) + 's' : '—';

    document.getElementById('compareTitle').textContent = label;

    // Meta text
    if (snap.status === 'diff') {
      document.getElementById('compareMeta').textContent =
        `${pct}% diff · ${snap.diffPixels.toLocaleString()} px changed · ${durationS}`;
    } else if (snap.status === 'new') {
      document.getElementById('compareMeta').textContent = 'New snapshot · no baseline';
    } else if (snap.status === 'pass') {
      document.getElementById('compareMeta').textContent = `No differences · ${durationS}`;
    } else {
      document.getElementById('compareMeta').textContent = '—';
    }

    // Images — for passing tests, show baseline in both panes
    const baselineSrc = snap.baselineUrl || null;
    const actualSrc   = snap.actualUrl   || (snap.status === 'pass' ? snap.baselineUrl : null);
    const diffSrc     = snap.diffUrl     || null;

    // Swipe view
    setImg(document.getElementById('swipeBaselineImg'), document.getElementById('baselinePlaceholder'), baselineSrc);
    setImg(document.getElementById('swipeActualImg'),   document.getElementById('actualPlaceholder'),   actualSrc);

    // Side-by-side view
    const sbsB = document.getElementById('sbsBaselineImg');
    const sbsA = document.getElementById('sbsActualImg');
    sbsB.src = bust(baselineSrc); sbsB.style.display = baselineSrc ? '' : 'none';
    sbsA.src = bust(actualSrc);   sbsA.style.display = actualSrc   ? '' : 'none';

    // Diff view
    const diffImg   = document.getElementById('diffViewImg');
    const diffEmpty = document.getElementById('diffImgEmpty');
    if (diffSrc) {
      diffImg.src = bust(diffSrc);
      diffImg.style.display = '';
      diffEmpty.style.display = 'none';
    } else {
      diffImg.style.display = 'none';
      diffEmpty.style.display = '';
    }

    // Diff stats
    const statDiff = document.getElementById('statDiff');
    statDiff.textContent = pct + '%';
    statDiff.className   = 'diff-stat-value ' + (snap.diffRatio > 0.01 ? 'error' : snap.diffRatio > 0 ? 'warning' : 'success');

    const statPx = document.getElementById('statPx');
    statPx.textContent = snap.diffPixels.toLocaleString();
    statPx.className   = 'diff-stat-value ' + (snap.diffPixels > 100 ? 'warning' : 'success');

    document.getElementById('statTime').textContent = durationS;
    document.getElementById('statCoverage').textContent = pct + '% affected';
    document.getElementById('statCoverage').style.color = snap.diffRatio > 0.01 ? 'var(--error)' : 'var(--success)';
    document.getElementById('diffFill').style.width = Math.min(snap.diffRatio * 1000, 100) + '%';

    // Show/hide panels
    document.getElementById('emptyState').style.display   = 'none';
    document.getElementById('approvedBanner').style.display = snap.status === 'pass' ? 'flex' : 'none';
    document.getElementById('newBanner').style.display      = snap.status === 'new'  ? 'flex' : 'none';
    document.getElementById('diffStats').style.display      = snap.status === 'diff' ? ''     : 'none';

    // Approve / Reject buttons
    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn  = document.getElementById('rejectBtn');

    if (snap.status === 'pass') {
      approveBtn.style.display = 'none';
      rejectBtn.style.display  = 'none';
    } else if (snap.status === 'new') {
      approveBtn.style.display = '';
      document.getElementById('approveBtnLabel').textContent = 'Set as Baseline';
      rejectBtn.style.display = 'none';
    } else {
      approveBtn.style.display = '';
      document.getElementById('approveBtnLabel').textContent = 'Approve';
      rejectBtn.style.display = '';
    }
  }

  /* ── Swipe slider ───────────────────────────────────────── */
  function onSwipe(val) {
    const pct = parseInt(val, 10);
    document.getElementById('actualPane').style.clipPath   = `inset(0 0 0 ${pct}%)`;
    document.getElementById('swipeDivider').style.left    = pct + '%';
    document.getElementById('swipeHandle').style.left     = pct + '%';
  }

  /* ── View modes ─────────────────────────────────────────── */
  function setViewMode(mode, btn) {
    currentView = mode;
    document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('swipeView').style.display = mode === 'swipe' ? '' : 'none';
    document.getElementById('sideView').style.display  = mode === 'side'  ? '' : 'none';
    document.getElementById('diffView').style.display  = mode === 'diff'  ? '' : 'none';
  }

  /* ── Approve / Reject ───────────────────────────────────── */
  async function approveCurrent() {
    if (!currentSnap || !currentSnap.actualUrl) {
      showToast('No actual screenshot available to approve.', 'error');
      return;
    }
    try {
      const resp = await fetch(`/api/snapshots/${currentSnap.name}/approve`, { method: 'POST' });
      if (!resp.ok) throw new Error((await resp.json()).error || 'Server error');
      showToast(`Baseline updated for: ${formatLabel(currentSnap.label)}`, 'success');
      // Update local state
      currentSnap.status     = 'pass';
      currentSnap.diffPixels = 0;
      currentSnap.diffRatio  = 0;
      currentSnap.baselineUrl = currentSnap.actualUrl;
      currentSnap.actualUrl  = null;
      currentSnap.diffUrl    = null;
      // Re-render list and panel
      allSnapshots = allSnapshots.map(s => s.name === currentSnap.name ? currentSnap : s);
      renderList(allSnapshots);
      updateSummary(allSnapshots);
      selectSnapshot(currentSnap);
    } catch (e) {
      showToast('Approve failed: ' + e.message, 'error');
    }
  }

  function rejectCurrent() {
    showToast('Snapshot rejected — flagged for developer review.', 'error');
  }

  async function approveAll() {
    const diffs = allSnapshots.filter(s => s.status === 'diff' || s.status === 'new');
    if (!diffs.length) { showToast('No diffs or new snapshots to approve.', 'warn'); return; }
    let approved = 0;
    for (const snap of diffs) {
      if (!snap.actualUrl) continue;
      try {
        const resp = await fetch(`/api/snapshots/${snap.name}/approve`, { method: 'POST' });
        if (resp.ok) {
          snap.status     = 'pass';
          snap.diffPixels = 0;
          snap.diffRatio  = 0;
          snap.baselineUrl = snap.actualUrl;
          snap.actualUrl  = null;
          snap.diffUrl    = null;
          approved++;
        }
      } catch { /* skip */ }
    }
    allSnapshots = [...allSnapshots];
    renderList(allSnapshots);
    updateSummary(allSnapshots);
    if (currentSnap) selectSnapshot(allSnapshots.find(s => s.name === currentSnap.name) || allSnapshots[0]);
    showToast(`${approved} snapshot${approved !== 1 ? 's' : ''} approved as new baselines.`, 'success');
  }

  /* ── Run visual tests (SSE) ─────────────────────────────── */
  function runVisualTests(update = false) {
    if (vrunES) { vrunES.close(); vrunES = null; }

    const overlay = document.getElementById('vrunOverlay');
    const output  = document.getElementById('vrunOutput');
    const status  = document.getElementById('vrunStatus');
    const doneBtn = document.getElementById('vrunDoneBtn');

    output.innerHTML = '';
    status.innerHTML = '<span class="dot-pulse"><span></span><span></span><span></span></span>&nbsp; Running…';
    doneBtn.style.display = 'none';
    overlay.classList.add('active');

    const url = `/api/run-visual${update ? '?update=1' : ''}`;
    vrunES = new EventSource(url);

    vrunES.onmessage = e => {
      const msg = JSON.parse(e.data);
      if (msg.type === 'line') {
        const span = document.createElement('span');
        span.className = msg.level ? 'line-' + msg.level : '';
        span.textContent = msg.text;
        output.appendChild(span);
        output.scrollTop = output.scrollHeight;
      } else if (msg.type === 'visual-done') {
        vrunES.close(); vrunES = null;
        if (msg.data) {
          allSnapshots = msg.data.snapshots || [];
          renderList(allSnapshots);
          updateSummary(allSnapshots);
          const first = allSnapshots.find(s => s.status === 'diff' || s.status === 'new') || allSnapshots[0];
          if (first) selectSnapshot(first);
        }
        const total   = allSnapshots.length;
        const passed  = allSnapshots.filter(s => s.status === 'pass').length;
        const newSnap = allSnapshots.filter(s => s.status === 'new').length;
        const diffs   = allSnapshots.filter(s => s.status === 'diff').length;

        // Append a user-friendly summary to the terminal
        const summarySpan = document.createElement('span');
        summarySpan.className = 'line-info';
        if (newSnap > 0 && diffs === 0) {
          summarySpan.textContent =
            `\n✔  Run complete. ${newSnap} new snapshot${newSnap > 1 ? 's' : ''} captured.\n` +
            `   → Click "Approve All Diffs" (or approve individually) to save them as baselines.\n`;
        } else if (diffs > 0) {
          summarySpan.textContent =
            `\n⚠  Run complete. ${diffs} visual difference${diffs > 1 ? 's' : ''} detected.\n` +
            `   → Review each diff in the panel and approve or reject.\n`;
        } else {
          summarySpan.textContent = `\n✔  All ${passed} snapshot${passed !== 1 ? 's' : ''} match their baselines.\n`;
          summarySpan.className = 'line-success';
        }
        output.appendChild(summarySpan);
        output.scrollTop = output.scrollHeight;

        status.textContent = newSnap
          ? `${newSnap} new snapshot${newSnap > 1 ? 's' : ''} — approve to set as baselines`
          : diffs
          ? `${diffs} diff${diffs > 1 ? 's' : ''} found — review in the panel`
          : `All ${passed} snapshots passed`;
        doneBtn.style.display = '';
      }
    };

    vrunES.onerror = () => {
      if (vrunES) { vrunES.close(); vrunES = null; }
      status.textContent = 'Connection error';
      doneBtn.style.display = '';
    };
  }

  function closeVisualRun() {
    if (vrunES) { vrunES.close(); vrunES = null; }
    document.getElementById('vrunOverlay').classList.remove('active');
  }

  /* ── Toast ──────────────────────────────────────────────── */
  function showToast(msg, type = 'success') {
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:8px;font-size:0.8rem;font-weight:600;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.15);animation:fadeIn 0.2s ease;max-width:340px;';
    t.style.background = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--running)';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3200);
  }

  /* ── Keyboard shortcuts ─────────────────────────────────── */
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key === 'a' || e.key === 'A') approveCurrent();
    if (e.key === 'r' || e.key === 'R') rejectCurrent();
  });

  /* ── Init ───────────────────────────────────────────────── */
  loadSnapshots();
</script>
</body>
</html>
